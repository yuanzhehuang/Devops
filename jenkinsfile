pipeline {
    agent any
    environment {
        PATH=sh(script:"echo $PATH:/usr/local/bin", returnStdout:true).trim()
        AWS_REGION = "us-east-1"
        AWS_ACCOUNT_ID=sh(script:'export PATH="$PATH:/usr/local/bin" && aws sts get-caller-identity --query Account --output text', returnStdout:true).trim()
        ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        APP_REPO_NAME = "ecr-repo/todo-app"
        APP_NAME = "todo"
        HOME_FOLDER = "/home/ec2-user"
        GIT_FOLDER = sh(script:'echo ${GIT_URL} | sed "s/.*\\///;s/.git$//"', returnStdout:true).trim()
    }

    stages {
        stage('Build Infrastructure for App') {
            steps {
                sh 'terraform init'
                sh 'terraform apply --auto-approve'
            }
        }
        stage('Create ECR Repository') {
            steps {
                sh """aws ecr create-repository \
                --repository-name $APP_REPO_NAME \
                --region $AWS_REGION"""
            }
        }
        stage('Build App Docker Images') {
            steps {
                sh 'docker build -t nodejs-app nodejs/server/'
                sh 'docker tag nodejs-app:latest 975050139159.dkr.ecr.us-east-1.amazonaws.com/ecr-repo/todo-app:latest'
                sh 'docker push 975050139159.dkr.ecr.us-east-1.amazonaws.com/ecr-repo/todo-app:latest'
            }
        }
    }
}